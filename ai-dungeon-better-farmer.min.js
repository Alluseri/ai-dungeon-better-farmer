// ==UserScript==
// @name         AI Dungeon Better Farmer
// @namespace    https://www.youtube.com/playlist?list=PLuPCd5VIscosG72QWT03BBZriNDEbryea
// @version      2.3
// @description  Gets rid of the need to spend your precious time to watch ads.
// @author       Alluseri
// @match        https://play.aidungeon.io/*
// @icon         https://cdn.discordapp.com/attachments/853155168170147910/1022980412731039855/hibi_transp.ico
// @grant        none
// ==/UserScript==

!function(){"use strict";(async()=>{var e=!1;try{e=!!require}catch{e=!1}e?(console.log("Running in Node.js environment."),await async function(){const e=require("node-fetch"),n=require("readline").createInterface(process.stdin,process.stdout),t=async e=>await new Promise((t=>n.question(e,t))),o=require("fs-extra");if(!o.existsSync("login.txt"))return void console.log("ERROR: Credentials file doesn't exist.");const a=o.readFileSync("login.txt").split("\n"),i=a[0],r=a[1];console.log("For advanced users(feel free to skip all of the below):");const s=(await t("Enter your useragent: ")).trim()||"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36",d=s.toLowerCase(),l="AIzaSyCnvo_XFPmAabrDkOKBRpbivp5UH8r_3mg",c=(await t("Enter your Firebase CV: ")).trim()||"Chrome/JsCore/9.6.7/FirebaseCore-web",u=(await t("Enter your Firebase UA: ")).trim()||"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36",p={origin:"https://play.aidungeon.io","x-client-version":c,"user-agent":u,"content-type":"application/json"},m=e=>({origin:"https://play.aidungeon.io","user-agent":d,"content-type":"application/json",authorization:e}),y={firebaseLogin:JSON.stringify({operationName:"EventHookSendUserEvent",variables:{input:{eventName:"logged_in_email_firebase",variation:"aidungeon",clientInfo:{os:"mobile",model:d,version:"unknown",buildNumber:"unknown",appVersion:"unknown",applicationName:"unknown"}}},query:"mutation EventHookSendUserEvent($input: EventInput) {\n  sendUserEvent(input: $input)\n}\n"}),getUserData:JSON.stringify({operationName:"UserContextGetUser",variables:{},query:"query UserContextGetUser {\n  user {\n    id\n    createdAt\n    acceptCommunityGuidelines\n    blockedUsers\n    canCreatorApply\n    creator\n    email\n    accessibleFeatures\n    hasPremium\n    isAlpha\n    isCurrentUser\n    isDeveloper\n    enableTestPayments\n    newNotificationCount\n    privateId\n    firebaseUid\n    rewardAvailable\n    shouldPromptReview\n    shouldShowModelPromo\n    username\n    verifiedAt\n    hasHadSubscriptionAccess\n    profile {\n      id\n      shortId\n      title\n      description\n      thumbImageUrl\n      __typename\n    }\n    activePremium {\n      userId\n      name\n      status\n      platform\n      activeUntil\n      accessUntil\n      subscriptionId\n      __typename\n    }\n    actionsBalance {\n      id\n      currentBalance\n      __typename\n    }\n    creditsBalance {\n      id\n      currentBalance\n      __typename\n    }\n    scalesBalance {\n      id\n      currentBalance\n      __typename\n    }\n    goldBalance {\n      id\n      currentBalance\n      __typename\n    }\n    gameSettings {\n      id\n      ai21CountPen\n      ai21FreqPen\n      ai21PresPen\n      alignCommands\n      bannedWords\n      commandList\n      defaultMode\n      displayColors\n      displayTheme\n      enableAlpha\n      enableBeta\n      griffinRepPen\n      isFullScreen\n      lowBandwidth\n      memoryLength\n      mobileActionWindowSize\n      modelType\n      nsfwGeneration\n      searchfilterFollowing\n      searchfilterPublished\n      searchfilterSafe\n      searchfilterThirdPerson\n      showFeedback\n      showIconText\n      showModes\n      storyLineBreak\n      temperature\n      textFont\n      textLength\n      textSize\n      textSpeed\n      topK\n      topP\n      trainTheAi\n      unrestrictedInput\n      webActionWindowSize\n      worldInfoCardStyle\n      settingsDrawerOpened\n      advancedSettingsOpened\n      imageCacheSelected\n      rawModelOutput\n      imageSettingsOpened\n      imgWidth\n      imgHeight\n      imgCfgScale\n      imgSteps\n      imgSampler\n      imgSeed\n      imgSeedSafe\n      shouldAutoplayAds\n      activeTab\n      __typename\n    }\n    newProductUpdates {\n      id\n      title\n      description\n      createdAt\n      __typename\n    }\n    continueAdventure {\n      id\n      publicId\n      __typename\n    }\n    __typename\n  }\n}\n"})};function g(e,n){return{operationName:"EventHookSendUserEvent",variables:{input:{eventName:e,variation:"mobile",clientInfo:n}},query:"mutation EventHookSendUserEvent($input: EventInput) {\n  sendUserEvent(input: $input)\n}\n"}}async function h(n,t){return await(await e(n,t)).json()}async function f(n,t){return await(await e("https://api.aidungeon.io/graphql",{method:"POST",body:JSON.stringify(t),headers:{authorization:n,"content-type":"application/json",accept:"*/*","user-agent":s}})).json()}var w=async function(e,n){var t={os:"mobile",model:d,version:"unknown"},o=g("ad_reward_button_press",t),a=g("ad_rewarded_reward_earned",t),i={operationName:"IncreaseAdCounterAdContext",variables:{},query:"mutation IncreaseAdCounterAdContext($addActions: Int) {\n  increaseAdCountdown(addActions: $addActions)\n}\n"},r={operationName:"UserContextGetAdCountdown",variables:{},query:"query UserContextGetAdCountdown {\n  adCountdown {\n    id\n    currentCount\n    enforceAds\n    shouldAutoplayAds\n    __typename\n  }\n}\n"};return n?(f(e,o),f(e,a),f(e,i)):(await f(e,o),await f(e,a),await f(e,i)),(await f(e,r)).data.adCountdown.currentCount};await e("https://play.aidungeon.io/main/loginRegister",{method:"GET",referrer:"",headers:{"user-agent":s}});var v=await h("https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key="+l,{method:"POST",referrer:"",headers:p,body:JSON.stringify({returnSecureToken:!0,email:i,password:r})});setTimeout((()=>{throw"Token has timed out. Please reopen the application."}),1e3*v.expiresIn);var b=v.idToken;if((await h("https://identitytoolkit.googleapis.com/v1/accounts:lookup?key="+l,{method:"POST",referrer:"",headers:p,body:JSON.stringify({idToken:b})})).users[0].disabled)throw"Your account is disabled.";var C="firebase "+b;await e("https://api.aidungeon.io/graphql",{method:"POST",referrer:"https://play.aidungeon.io/",headers:m(C),body:y.firebaseLogin});var S=await h("https://api.aidungeon.io/graphql",{method:"POST",referrer:"https://play.aidungeon.io/",headers:m(C),body:y.getUserData}),A=S.data.user.profile.title||S.data.user.username;console.log("\nWelcome, "+A+"!"),console.log("Please pick the farmer mode."),console.log("1. Default mode(safest)"),console.log("2. Fast mode(safe, out-of-sync)"),console.log("3. Super fast mode(unsafe)"),console.log("*. Exit");var T=(await t("> ")).trim()-0;if(![1,2,3].includes(T))return void process.exit();console.log("Please add AT MOST (10 * 80) actions everyday for your own safety!!!");var k=(await t("Add this many actions * 80: ")).trim()-0||1;switch(T){case 1:for(var _=1;_<=k;_++)console.log("Your current actions: "+await w(C,!1)+"(farmed "+_+" * 80 actions)");console.log("Routine finished, you may exit now.");break;case 2:for(var x=1;x<=k;x++)console.log("Your current actions: "+await w(C,!0)+"(farmed "+x+" * 80 actions)");console.log("Routine finished, you may exit in 5 seconds.");break;case 3:for(var N=1;N<=k;N++)w(C,!0),console.log("Farmed "+N+" * 80 actions(can't evaluate current actions)");console.log("Routine finished, you may exit in around "+k+" seconds.")}}()):(console.log("Running in UserScript environment."),function(){var e;const n=document.querySelector.bind(document);function t(e,n,t,o){var a=document.createElement(e);for(let e in n||{})a[e]=n[e];var i=o?"Array"==o.constructor.name?o:[o]:[];for(let e in i)a.appendChild(i[e]);return(t||(e=>e))(a)}const o=(e,n)=>(e.style.cssText=n.style.cssText,e);function a(e,n){return{operationName:"EventHookSendUserEvent",variables:{input:{eventName:e,variation:"web",clientInfo:n}},query:"mutation EventHookSendUserEvent($input: EventInput) {\n  sendUserEvent(input: $input)\n}\n"}}async function i(n){return await(await fetch("https://api.aidungeon.io/graphql",{method:"POST",body:JSON.stringify(n),headers:{authorization:e,"content-type":"application/json",accept:"*/*"}})).json()}function r(e){var r=e.firstElementChild,s=r.firstElementChild,d=s.lastElementChild,l=n("[aria-label='Settings']"),c=document.createElement("span");c.innerText="AIDBF READY!",c.style.color=n("[aria-label='Story']").firstChild.firstChild.firstChild.firstChild.style.color,c.style.fontSize="24px",c.style.marginTop="-7px",l.parentElement.insertBefore(c,l);var u=async function(e,n,t){var o={os:"web",model:navigator.userAgent.toLowerCase(),version:"unknown"},r=a("ad_reward_button_press",o),s=a("ad_rewarded_reward_earned",o),d={operationName:"IncreaseAdCounterAdContext",variables:{},query:"mutation IncreaseAdCounterAdContext($addActions: Int) {\n  increaseAdCountdown(addActions: $addActions)\n}\n"},l={operationName:"UserContextGetAdCountdown",variables:{},query:"query UserContextGetAdCountdown {\n  adCountdown {\n    id\n    currentCount\n    enforceAds\n    shouldAutoplayAds\n    __typename\n  }\n}\n"};n.style.backgroundColor="#F64627",n.style.borderColor="#E24C32",t?(i(r),i(s),i(d)):(await i(r),await i(s),await i(d)),n.style.backgroundColor="#43DB7C",n.style.borderColor="#30F178",e.innerText=(await i(l)).data.adCountdown.currentCount+" Actions",n.style.backgroundColor=n.ogBg,n.style.borderColor=n.ogBorder};t("div",{className:r.className},(n=>(n.style.cssText=r.style.cssText,n.ogBg=n.style.backgroundColor="#112244",n.ogBorder=n.style.borderColor="#223355",n.onclick=u.bind(globalThis,c,n,!1),e.appendChild(n),n)),t("div",{className:s.className},(e=>o(e,s)),t("div",{className:d.className,innerText:"+80 ACTIONS"},(e=>o(e,d))))),t("div",{className:r.className},(n=>(n.style.cssText=r.style.cssText,n.ogBg=n.style.backgroundColor="#113355",n.ogBorder=n.style.borderColor="#224466",n.onclick=u.bind(globalThis,c,n,!0),e.appendChild(n),n)),t("div",{className:s.className},(e=>o(e,s)),t("div",{className:d.className,innerText:"+80 ACTIONS [FAST]"},(e=>o(e,d)))))}d=0,l=globalThis.setTimeout,globalThis.setTimeout=function(e,t){if(!document.location.href.includes("/main/adventurePlay"))return(globalThis.setTimeout=l)(e,t);if(e.toString().match(/function\(\){return \w+\(!0\)}/)&&console.log("[AIDBF] Capture: "+ ++d),d>=3){var o=n('[aria-label="Commands list"]');if(!o)return l(e,t);r(o),globalThis.setTimeout=l}return l(e,t)},s=window.WebSocket.prototype.send,window.WebSocket.prototype.send=function(n){var t=JSON.parse(n);return"connection_init"==t.type&&(e=t.payload.token,window.WebSocket.prototype.send=s),s.apply(this,arguments)};var s;var d,l}())})()}();
